@model FP.Models.FloorplanDto

@{
    ViewBag.Title = "Edit Floorplan";
}

@section head {}

<div class="row floorplan-edit">
    <div class="col-md-9 left-panel">
        @*<div class="image-temp-holder"><img src="@Html.Raw(Model.ImageURL)"  class="img-fluid" id="responsive-image"/></div>*@
        <div class="canvas-container">
            <canvas id="floorplan-canvas"></canvas>
        </div>
    </div>
    <div class="col-md-3 right-panel">
        @using (Html.BeginForm(null, null, FormMethod.Post, new { enctype = "multipart/form-data", onsubmit = "preSubmit(event)", @class = "edit-form" }))
        {
            @Html.AntiForgeryToken()
            @Html.ValidationSummary(true)
            @Html.HiddenFor(model => model.FloorplanId)
            @Html.HiddenFor(model => model.OriginatingSystemIdValue)
            @Html.HiddenFor(model => model.DateAdded)
            @Html.HiddenFor(model => model.DateModified)
            @Html.HiddenFor(model => model.AddedByUserProfileId)
            @Html.HiddenFor(model => model.ModifiedByUserProfileId)
            @Html.HiddenFor(model => model.ImageURL)

            <div class="floorplan-details">
                <h5>
                    Floorplan Details
                    <a class="btn btn-sm" data-toggle="collapse" href="#f-details" role="button" aria-expanded="false">
                        <i class="fas fa-minus-square"></i>
                    </a>
                </h5>
                <div id="f-details" class="section-container collapse show">
                    <div class="form-group">
                        <label>Name</label>
                        @Html.TextBoxFor(model => model.Name, new { @class = "form-control form-control-sm" })
                        <div>@Html.ValidationMessageFor(model => model.Name, "", new { @class = "text-danger" })</div>
                    </div>
                    <div class="form-group">
                        <label>Code</label>
                        @Html.TextBoxFor(model => model.Code, new { @class = "form-control form-control-sm" })
                        <div>@Html.ValidationMessageFor(model => model.Code, "", new { @class = "text-danger" })</div>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        @Html.TextBoxFor(model => model.Description, new { @class = "form-control form-control-sm" })
                        <div>@Html.ValidationMessageFor(model => model.Description, "", new { @class = "text-danger" })</div>
                    </div>
                    <div class="form-group">
                        <label>Contract</label>
                        @Html.DropDownList("ContractId")
                    </div>
                    <div class="form-group">
                        <label>Property Type</label>
                        @Html.DropDownList("PropertyTypeCode")
                        <div>@Html.ValidationMessageFor(model => model.PropertyTypeCode, "", new { @class = "text-danger" })</div>
                    </div>
                    <div class="form-group file-upload">
                        <div class="label">Floorplan Image</div>
                        <input type="file" name="ImageUpload" id="ImageUpload" class="inputfile" data-multiple-caption="{count} files selected" multiple />
                        <label for="ImageUpload"><span><i class="fas fa-upload"></i> Choose a file</span></label>
                    </div>
                    <div class="form-group">
                        <div class="buttons">
                            <button type="submit" class="btn btn-primary btn-sm"><i class="fas fa-check"></i> Save</button>
                            <a class="btn btn-primary btn-sm" href="/Floorplans/Index"><i class="fas fa-ban"></i> Cancel</a>
                            <a class="btn btn-primary btn-sm btn-delete btn-danger" href="javascript:$('.delete-confirm').removeClass('hidden');"><i class="fas fa-times" aria-hidden="true"></i> Delete</a>
                        </div>
                    </div>
                    <div class="form-group delete-confirm hidden">
                        <h6 class="pull-left">Are you sure you want to delete this item?</h6>
                        <p class="pull-right">
                            <a class="btn btn-primary btn-sm" href="javascript:$('.floorplan-delete-form').submit();">Yes</a>
                            <a class="btn btn-primary btn-sm" href="javascript:$('.delete-confirm').addClass('hidden');">No</a>
                        </p>
                        <div class="clearfix"></div>
                    </div>
                    <div id="alert-floorplan-item" class="@(String.IsNullOrEmpty(ViewBag.ShowOrHide) ? "hidden" : Html.Raw(ViewBag.ShowOrHide))">
                        <div class="alert @(String.IsNullOrEmpty(ViewBag.AlertType) ? "alert-info" : Html.Raw(ViewBag.AlertType))" role="alert">
                            <button type="button" class="close" onclick="javascript:$('#alert-floorplan-item').addClass('hidden');"><span aria-hidden="true">&times;</span></button>
                            <span class="message">@ViewBag.Message</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="floorplan-locations">
                <h5>
                    Floorplan Rooms
                    <a class="btn btn-sm" data-toggle="collapse" href="#f-rooms" role="button" aria-expanded="false">
                        <i class="fas fa-plus-square"></i>
                    </a>
                </h5>
                <div id="f-rooms" class="section-container collapse">
                    <div class="form-group">
                        <label>Plotted Rooms</label>
                        <div class="input-group mb-2">
                            @Html.DropDownList("CurrentLocations", (IEnumerable<SelectListItem>)ViewBag.CurrentLocations, "Please select", new { @class = "form-control form-control-sm" })
                            <div class="input-group-append">
                                <a id="add-location" class="btn btn-sm btn-primary"><i class="fa fa-plus" aria-hidden="true"></i> Add</a>
                            </div>
                        </div>
                    </div>
                    <div id="active-location" class="hidden">
                        <div class="form-group" id="system-locations">
                            <label>All Locations</label>
                            @Html.DropDownList("Locations", (IEnumerable<SelectListItem>)ViewBag.Locations, new { @class = "form-control form-control-sm" })
                        </div>
                        <div class="form-group" id="location-description">
                            <label>Name</label>
                            <input type="text" class="form-control form-control-sm" id="location-description-input">
                        </div>
                        <div class="row no-gutters min-max">
                            <div class="col-6">
                                <div class="input-group mb-2">
                                    <div class="input-group-prepend">
                                        <div class="input-group-text">
                                            MinX
                                        </div>
                                    </div>
                                    <input type="text" class="form-control" id="MinX">
                                </div>
                                <div class="input-group mb-2">
                                    <div class="input-group-prepend">
                                        <div class="input-group-text">
                                            MinY
                                        </div>
                                    </div>
                                    <input type="text" class="form-control" id="MaxX">
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="input-group mb-2">
                                    <div class="input-group-prepend">
                                        <div class="input-group-text">
                                            MaxX
                                        </div>
                                    </div>
                                    <input type="text" class="form-control" id="MinY">
                                </div>
                                <div class="input-group mb-2">
                                    <div class="input-group-prepend">
                                        <div class="input-group-text">
                                            MaxY
                                        </div>
                                    </div>
                                    <input type="text" class="form-control" id="MaxY">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="buttons">
                                <a id="save-active-location" class="btn btn-sm btn-primary" href="javascript:;"><i class="fas fa-check" aria-hidden="true"></i> Save Room</a>
                                <a id="delete-active-location" class="btn btn-sm btn-primary btn-danger" href="javascript:$('.delete-location-confirm').removeClass('hidden');"><i class="fas fa-times" aria-hidden="true"></i> Delete Room</a>
                            </div>
                        </div>
                        <div class="form-group delete-location-confirm hidden">
                            <h6 class="pull-left">Are you sure you want to delete this room?</h6>
                            <p class="pull-right">
                                <a class="btn btn-primary btn-sm" href="javascript:;" id="delete-active-location-confirmed">Yes</a>
                                <a class="btn btn-primary btn-sm" href="javascript:$('.delete-location-confirm').addClass('hidden');">No</a>
                            </p>
                            <div class="clearfix"></div>
                        </div>
                        <div id="alert-floorplan-locations" class="hidden">
                            <div class="alert alert-info" role="alert">
                                <button type="button" class="close" onclick="javascript:$('#alert-floorplan-locations').addClass('hidden');"><span aria-hidden="true">&times;</span></button>
                                <span class="message"></span>
                            </div>
                        </div>
                    </div>

                </div>
            </div>


        }
    </div>

    @using (Html.BeginForm("Delete", "Floorplans", FormMethod.Post, new { @class = "floorplan-delete-form" }))
    {
        @Html.AntiForgeryToken()
        <input type='hidden' name="id" value="@Model.FloorplanId" />
        @Html.HiddenFor(model => model.FloorplanId)
        <input type="submit" value="Delete" />
    }
</div>

@section scripts {

    @Scripts.Render("~/bundles/jqueryval")

    <script type="text/javascript">


        
        var floorplanOriginalImage = new Image();

        floorplanOriginalImage.onload = function () {
            window.floorplanOriginalImage = {
                width: floorplanOriginalImage.width,
                height: floorplanOriginalImage.height
            };
        }

        floorplanOriginalImage.src = '@Html.Raw(Model.ImageURL)'; 

        var windowResize = function () {

            var responsiveImage = $(document.getElementById("responsive-image"));
            responsiveImage.parent().show();
            var canvas = document.getElementById("floorplan-canvas");
            var canvasContainer = $(".canvas-container");
            canvas.width = responsiveImage.width();
            canvas.height = responsiveImage.height();
            canvasContainer.css("background", "#fff url(@Html.Raw(Model.ImageURL)) top left no-repeat");
            canvasContainer.css("background-size", responsiveImage.width() + "px " + responsiveImage.height() + "px");
            responsiveImage.parent().hide();


        };

        var setCanvasSizeBG = function () {
            var canvas = document.getElementById("floorplan-canvas");

            var img = new Image();
            img.onload = function () {

                canvas.width = this.width;
                canvas.height = this.height;
            }
            img.src = '@Html.Raw(Model.ImageURL)';
            $(canvas).css("background", "#fff url(@Html.Raw(Model.ImageURL)) top left no-repeat");
        };

        var initFileInput = function () {
            var inputs = document.querySelectorAll('.inputfile');
            Array.prototype.forEach.call(inputs, function (input) {
                var label = input.nextElementSibling,
                    labelVal = label.innerHTML;

                input.addEventListener('change', function (e) {
                    var fileName = '';
                    if (this.files && this.files.length > 1)
                        fileName = (this.getAttribute('data-multiple-caption') || '').replace('{count}', this.files.length);
                    else
                        fileName = e.target.value.split('\\').pop();

                    if (fileName)
                        label.querySelector('span').innerHTML = fileName;
                    else
                        label.innerHTML = labelVal;
                });
            });
        };


        $(document).ready(function () {
            $('#ContractId, #PropertyTypeCode').addClass("form-control form-control-sm");

            floorplans.init();



            

            // Make canvas actual size
            setCanvasSizeBG();

            // Make canvas size responsive
            // windowResize();

            initFileInput();


        });

        //$(window).resize(function () {
        //    windowResize();
        //});
    </script>


}
